<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상세 분석 리포트</title>
    <link rel="stylesheet" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #101010;
            --surface-color: #1c1c1e;
            --surface-light: #252527;
            --primary: #3182f6;
            --primary-dim: rgba(49, 130, 246, 0.15);
            --text-primary: #ffffff;
            --text-secondary: #8b95a1;
            --danger: #ef4444;
            --success: #34c759;
            --warning: #ffb300;
        }

        body {
            font-family: 'Pretendard', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            padding: 40px 20px;
        }

        .back-btn {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 24px;
            padding: 8px 16px;
            background: var(--surface-color);
            border-radius: 20px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            color: var(--text-primary);
            background: #2c2c2e;
        }

        .header {
            margin-bottom: 32px;
        }

        h1 {
            font-size: 32px;
            margin: 0 0 12px 0;
            font-weight: 700;
        }

        .subtitle {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .current-value {
            font-size: 28px;
            font-weight: 700;
        }

        .change-badge {
            font-size: 16px;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
        }

        .change-badge.positive {
            background: rgba(52, 199, 89, 0.15);
            color: var(--success);
        }

        .change-badge.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .chart-box {
            background: var(--surface-color);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
        }

        .period-tabs {
            display: flex;
            gap: 8px;
        }

        .period-btn {
            background: #2c2c2e;
            border: none;
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn:hover {
            color: var(--text-primary);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .report-box {
            background: var(--surface-color);
            border-radius: 20px;
            padding: 28px;
        }

        .report-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-content {
            line-height: 1.8;
            font-size: 15px;
            color: #e0e0e0;
        }

        /* === 분석 리포트 스타일 === */

        /* 섹션 카드 */
        .analysis-section {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-label::before {
            content: '';
            width: 4px;
            height: 16px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* 데이터 테이블 */
        .data-table-wrapper {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: linear-gradient(135deg, rgba(49, 130, 246, 0.2), rgba(49, 130, 246, 0.1));
            color: var(--primary);
            font-weight: 600;
            padding: 14px 16px;
            text-align: left;
            font-size: 13px;
            border-bottom: 2px solid var(--primary);
        }

        .data-table th:last-child {
            text-align: right;
        }

        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #3c3c3e;
            color: #e0e0e0;
            font-size: 14px;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: rgba(49, 130, 246, 0.05);
        }

        .data-table td:last-child {
            text-align: right;
            font-family: 'SF Mono', 'Consolas', monospace;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* 분석 텍스트 */
        .analysis-text {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            line-height: 1.9;
            color: #e8e8e8;
        }

        .analysis-text p {
            margin: 0 0 12px 0;
        }

        .analysis-text p:last-child {
            margin-bottom: 0;
        }

        /* 파급 효과 카드 */
        .impact-card {
            background: linear-gradient(135deg, rgba(49, 130, 246, 0.1), rgba(49, 130, 246, 0.05));
            border: 1px solid rgba(49, 130, 246, 0.2);
            border-radius: 16px;
            padding: 20px;
        }

        .impact-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .impact-text {
            color: #e0e0e0;
            line-height: 1.7;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s infinite linear;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-indicator {
            display: inline-flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .error-message {
            color: var(--danger);
            padding: 20px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="/scenario" class="back-btn">← 시나리오 실험실로 돌아가기</a>

        <header class="header">
            <h1 id="pageTitle">로딩 중...</h1>
            <div class="subtitle">
                <span class="current-value" id="currentValue">--</span>
                <span class="change-badge" id="changeBadge">--</span>
            </div>
        </header>

        <section class="chart-box">
            <div class="chart-header">
                <span class="chart-title">히스토리 차트</span>
                <div class="period-tabs">
                    <button class="period-btn" data-period="1m">1개월</button>
                    <button class="period-btn active" data-period="3m">3개월</button>
                    <button class="period-btn" data-period="1y">1년</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="detailChart"></canvas>
            </div>
        </section>

        <section class="report-box">
            <div class="report-title">AI 심층 분석 리포트</div>
            <div id="reportContent" class="report-content">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </section>
    </div>

    <script>
        let currentChart = null;
        let currentData = null;

        function getParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                source: params.get('source') || 'fred',
                ticker: params.get('ticker') || '',
                title: params.get('title') || '지표'
            };
        }

        async function init() {
            const { source, ticker, title } = getParams();

            if (!ticker) {
                document.getElementById('pageTitle').textContent = '오류: 티커 없음';
                document.getElementById('reportContent').innerHTML =
                    '<div class="error-message">티커 파라미터가 필요합니다.</div>';
                return;
            }

            document.getElementById('pageTitle').textContent = title;
            document.title = `${title} - 상세 분석`;

            await loadHistory(source, ticker);
            await loadAnalysis(source, ticker, title);
        }

        async function loadHistory(source, ticker) {
            try {
                const res = await fetch(`/api/v1/market/history/${source}/${ticker}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                currentData = data;
                renderChart(data.history, '3m');

                if (data.history && data.history.length > 0) {
                    const latest = data.history[data.history.length - 1];
                    const prev = data.history.length > 1 ? data.history[data.history.length - 2] : latest;

                    const value = latest.value;
                    const change = ((value - prev.value) / prev.value * 100).toFixed(2);

                    document.getElementById('currentValue').textContent = formatValue(value);

                    const badge = document.getElementById('changeBadge');
                    const isPositive = parseFloat(change) >= 0;
                    badge.textContent = `${isPositive ? '+' : ''}${change}%`;
                    badge.className = `change-badge ${isPositive ? 'positive' : 'negative'}`;
                }

            } catch (e) {
                console.error('History load error:', e);
                document.getElementById('currentValue').textContent = '데이터 로드 실패';
            }
        }

        function formatValue(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return value.toLocaleString();
            }
            return value.toFixed(2);
        }

        function renderChart(history, period) {
            if (!history || history.length === 0) return;

            let filtered = history;
            const now = new Date();

            if (period === '1m') {
                const cutoff = new Date(now.setMonth(now.getMonth() - 1));
                filtered = history.filter(h => new Date(h.date) >= cutoff);
            } else if (period === '3m') {
                const cutoff = new Date(now.setMonth(now.getMonth() - 3));
                filtered = history.filter(h => new Date(h.date) >= cutoff);
            }

            const ctx = document.getElementById('detailChart').getContext('2d');
            const labels = filtered.map(h => h.date);
            const values = filtered.map(h => h.value);

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(49, 130, 246, 0.4)');
            gradient.addColorStop(1, 'rgba(49, 130, 246, 0.0)');

            if (currentChart) currentChart.destroy();

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderColor: '#3182f6',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1c1c1e',
                            titleColor: '#8b95a1',
                            bodyColor: '#fff',
                            bodyFont: { size: 14, weight: 'bold' },
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: ctx => formatValue(ctx.parsed.y)
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { color: '#6b7684', maxTicksLimit: 6 }
                        },
                        y: {
                            position: 'right',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#6b7684',
                                callback: v => formatValue(v)
                            }
                        }
                    },
                    interaction: { mode: 'index', intersect: false }
                }
            });
        }

        async function loadAnalysis(source, ticker, title) {
            const reportEl = document.getElementById('reportContent');

            reportEl.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; color: var(--text-secondary);">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                    AI가 분석 중입니다...
                </div>
            `;

            try {
                const res = await fetch(`/api/v1/market/analyze/${source}/${ticker}?title=${encodeURIComponent(title)}`, {
                    method: 'POST'
                });
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                const analysis = data.analysis || '분석 결과를 가져올 수 없습니다.';
                reportEl.innerHTML = parseAndRenderAnalysis(analysis);

            } catch (e) {
                console.error('Analysis error:', e);
                reportEl.innerHTML = `
                    <div class="error-message">
                        AI 분석을 불러오는데 실패했습니다.<br>
                        <small style="color: var(--text-secondary);">${e.message}</small>
                    </div>
                `;
            }
        }

        /**
         * LLM 응답을 파싱하여 스타일링된 HTML로 렌더링
         */
        function parseAndRenderAnalysis(text) {
            // 1. 정리: 이모지, 마크다운 강조, 외국어 제거
            text = cleanText(text);

            const lines = text.split('\n');
            let html = '';
            let tableHeaders = [];
            let tableRows = [];
            let inTable = false;
            let textBuffer = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // 빈 줄
                if (!line) {
                    if (inTable && tableRows.length > 0) {
                        html += renderStyledTable(tableHeaders, tableRows);
                        inTable = false;
                        tableHeaders = [];
                        tableRows = [];
                    }
                    if (textBuffer.length > 0) {
                        html += renderTextSection(textBuffer);
                        textBuffer = [];
                    }
                    continue;
                }

                // # 헤더 제거 (LLM이 생성했을 경우)
                if (line.startsWith('#')) {
                    continue;
                }

                // 마크다운 표 감지
                if (line.startsWith('|') && line.endsWith('|')) {
                    // 구분선 스킵
                    if (line.includes('---')) continue;

                    const cells = line.split('|').filter(c => c.trim()).map(c => c.trim());

                    if (!inTable) {
                        inTable = true;
                        tableHeaders = cells;
                    } else {
                        tableRows.push(cells);
                    }
                } else {
                    // 테이블 종료 처리
                    if (inTable && tableRows.length > 0) {
                        html += renderStyledTable(tableHeaders, tableRows);
                        inTable = false;
                        tableHeaders = [];
                        tableRows = [];
                    }

                    // 일반 텍스트 수집
                    textBuffer.push(line);
                }
            }

            // 마지막 처리
            if (inTable && tableRows.length > 0) {
                html += renderStyledTable(tableHeaders, tableRows);
            }
            if (textBuffer.length > 0) {
                html += renderTextSection(textBuffer);
            }

            return html || '<div class="analysis-text"><p>분석 결과가 없습니다.</p></div>';
        }

        /**
         * 텍스트 정리 (이모지, 마크다운, 외국어 제거)
         */
        function cleanText(text) {
            // 이모지 제거
            text = text.replace(/[\u{1F600}-\u{1F6FF}|\u{1F300}-\u{1F5FF}|\u{1F680}-\u{1F6FF}|\u{2600}-\u{26FF}|\u{2700}-\u{27BF}|\u{1F900}-\u{1F9FF}]/gu, '');

            // ** 볼드 제거
            text = text.replace(/\*\*/g, '');

            // * 이탤릭 제거 (리스트 아이템 제외)
            text = text.replace(/(?<!\|)\*(?!\*)/g, '');

            // > 인용 제거
            text = text.replace(/^>\s*/gm, '');

            // ``` 코드블록 제거
            text = text.replace(/```[\s\S]*?```/g, '');

            // 중국어/일본어/베트남어 문자 제거 (한글, 영어, 숫자, 기본 기호 유지)
            text = text.replace(/[\u4E00-\u9FFF\u3040-\u309F\u30A0-\u30FF\u1E00-\u1EFF]/g, '');

            return text.trim();
        }

        /**
         * 스타일링된 테이블 렌더링
         */
        function renderStyledTable(headers, rows) {
            if (headers.length === 0 || rows.length === 0) return '';

            let html = `
                <div class="data-table-wrapper">
                    <div class="section-label">최근 데이터</div>
                    <table class="data-table">
                        <thead><tr>`;

            headers.forEach(h => {
                html += `<th>${escapeHtml(h)}</th>`;
            });

            html += '</tr></thead><tbody>';

            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${escapeHtml(cell)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table></div>';
            return html;
        }

        /**
         * 텍스트 섹션 렌더링
         */
        function renderTextSection(lines) {
            if (lines.length === 0) return '';

            // "자산 파급 효과" 또는 "파급 효과" 관련 텍스트 감지
            const combinedText = lines.join(' ');
            const isImpact = combinedText.includes('파급') || combinedText.includes('영향') || combinedText.includes('효과:');

            if (isImpact) {
                return `
                    <div class="impact-card">
                        <div class="impact-label">연관 자산 파급 효과</div>
                        <div class="impact-text">${lines.map(l => escapeHtml(l)).join('<br>')}</div>
                    </div>
                `;
            }

            return `
                <div class="analysis-text">
                    ${lines.map(l => `<p>${escapeHtml(l)}</p>`).join('')}
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 기간 탭 이벤트
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (currentData && currentData.history) {
                    renderChart(currentData.history, btn.dataset.period);
                }
            });
        });

        init();
    </script>
</body>

</html>