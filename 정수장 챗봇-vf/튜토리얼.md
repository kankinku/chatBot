튜토리얼: PDF 기반 RAG 파이프라인 빠른 시작 (Windows/Docker 공통)

1. 준비물
- Python 3.10 이상, PowerShell 권장(한글 콘솔은 `chcp 65001` 또는 `set PYTHONUTF8=1`)
- (선택) Docker Desktop + GPU
- (선택) Ollama(로컬 LLM) — Docker Compose로 함께 실행 가능

설치(권장 순서)
- CPU 환경(충돌 최소화 핀 고정):
  1) `pip install --upgrade pip`
  2) `pip install --upgrade --force-reinstall "torch==2.1.2" "torchvision==0.16.2" --index-url https://download.pytorch.org/whl/cpu`
  3) `pip install -r requirements.txt --extra-index-url https://download.pytorch.org/whl/cpu`
  - 호환성 메모: `numpy<2.0`로 고정, `sentence-transformers>=2.6.1`와 호환 검증됨.
- (옵션) GPU 환경: PyTorch 공식 가이드에 따라 CUDA 빌드 지정 설치 후 `pip install -r requirements.txt --no-deps`

2. 폴더/파일 배치
- 참고 PDF 넣기: 다음 중 편한 경로를 선택해 배치하세요.
  - 권장: `data/pdfs/` (없으면 새로 만드세요)
  - 혹은: 프로젝트 루트의 `pdfs/` 또는 이미 존재하는 `data/tests/`
  - 예: `data/tests/시스템 사용자 설명서(고산)_v.1.7_1.pdf`
- 샘플 QA JSON 넣기: `data/tests/qa.json`
  - 예시 내용(최소 한 항목):
    {
      "id": "ex1",
      "question": "정수장 유입수의 평균 탁도 기준은?",
      "answer": "없음",
      "tags": ["numeric"]
    }
- 출력 디렉터리: 결과 리포트는 `out/` 하위에 생성됨

3. 1분 원클릭 실행(Quickstart)
Quickstart는 입력(PDF 또는 기존 코퍼스)에 따라 코퍼스 생성 → (선택)벡터 인덱스 생성 → 실행(질문/CLI/벤치마크/서버)을 한 번에 처리합니다.

- 단일 질문 바로 테스트
  - PDFs → 코퍼스 생성 후 질문 1건 실행
  - 명령: `python scripts/quickstart.py --pdf data/tests --backend auto --question "<질문문장>"`
- 인터랙티브 입력(수동 CLI)
  - PDFs → 코퍼스 생성 후 대화형 CLI 시작
  - 명령: `python scripts/quickstart.py --pdf data/tests --backend auto --interactive`
- 벤치마크(샘플 QA JSON)
  - PDFs → 코퍼스 생성 후 하네스 실행, 리포트 저장
  - 명령: `python scripts/quickstart.py --pdf data/tests --qa data/tests/qa.json --backend auto`
- 서버 기동(API)
  - PDFs → 코퍼스 생성 후 API 서버 시작
  - 명령: `python scripts/quickstart.py --pdf data/tests --backend auto --server --host 0.0.0.0 --port 8000`

선택 옵션
- 벡터 백엔드: `--backend auto|faiss|hnsw` (faiss/hnsw 지정 시 인덱스 자동 생성)
- 리랭커: `--use-cross-reranker --rerank-top-n 50`
- 임계 튠: `--thr-base 0.25 --thr-numeric 0.16 --thr-long 0.17`
- PDF 추출기: `--pdf-extractor auto|plumber|fitz`(기본 auto)
 - OCR 자동화: `--ocr auto|always|off`(기본 auto), `--ocr-lang kor+eng`, `--ocr-dpi 200`

4. 수동 절차(원한다면)
- PDF → 코퍼스(JSONL) 생성
  - `python scripts/build_corpus_from_pdfs.py --pdf_dir pdfs --out data/corpus.jsonl --pdf-extractor auto --ocr auto --ocr-lang kor+eng --ocr-dpi 200`
- 코퍼스 → 벡터 인덱스 생성
  - FAISS: `python scripts/build_vector_index.py --corpus data/corpus.jsonl --backend faiss --outdir vector_store`
  - HNSW: `python scripts/build_vector_index.py --corpus data/corpus.jsonl --backend hnsw --outdir vector_store`
- 수동 CLI(질문 테스트)
  - `python scripts/manual_cli.py --corpus data/corpus.jsonl --mode accuracy --store-backend auto --question "<질문>"`
- 하네스(벤치마크)
  - `python scripts/run_qa_benchmark.py --input data/tests/qa.json --corpus data/corpus.jsonl --mode accuracy --store-backend auto --report out/report.json --csv out/report.csv`

5. 서버(API)
- 로컬(파이썬): `uvicorn server.app:app --host 0.0.0.0 --port 8000 --reload`
- 엔드포인트
  - `POST /api/ask {question, mode, k}`
  - `POST /api/qa/batch {items:[{id,question}], mode}`
  - `GET /healthz` (상태) / `GET /metrics` (간단 집계, 프로메테우스 형식)

6. Docker(선택)
- Docker Compose로 앱+Ollama 기동(볼륨/헬스체크 포함)
  - `docker compose up --build`
  - 볼륨: `./data ./models ./vector_store ./logs`
  - GPU: `gpus: all` (가능한 경우 자동 사용)

7. 결과 확인
- 벤치마크 리포트: `out/report_*.json`, `out/report_*.csv`
- 핵심 지표(요약)
  - 정확도(하네스 점수), `context_filled`, `filter_pass_rate`, `numeric_preservation`, `no_answer_rate`, `p50/p95 total_time_ms`
- 단일 질문 결과(수동 CLI): 답변/신뢰도/근거 스니펫/메트릭 출력

8. 데이터 계약(코퍼스 JSONL)
- 각 라인은 아래 키를 포함하는 JSON 객체입니다.
  - `doc_id, filename, page, start, length, text, extra{section, paragraph_id}`
- 안정 키(중복 제거/추적): `(doc_id|filename|page|start|length) + 텍스트 해시(앞 160자 정규화 md5)` — 파이프라인 내부에서 사용

9. 튠 가이드(정확도 우선)
- 리랭커 ON/OFF 및 `--rerank-top-n`(20/50/100) A/B
- 임계: `--thr-base`, `--thr-numeric`, `--thr-long`
- 백엔드: 대용량은 `--backend hnsw` 권장(M/ef 조정 여지)

10. 문제 해결(FAQ)
- 콘솔 한글 깨짐: PowerShell `chcp 65001` 또는 `set PYTHONUTF8=1`
- 벡터 인덱스 미사용: `--backend auto`(TF‑IDF 폴백)로 실행 가능
- PDF가 이미지 스캔본: OCR 전처리 필요(텍스트 추출 불가 시 코퍼스 비어 있음)
- Ollama 미기동: LLM이 비어도 추출형 폴백으로 응답(성능 저하 가능)
- 코퍼스가 0 chunks로 생성됨: 스캔 PDF 가능성 높음 → `--pdf-extractor fitz` 또는 OCR(예: OCRmyPDF/Acrobat 텍스트 인식) 후 재시도
  - 자동화됨: quickstart/build 스크립트가 `--ocr auto`일 때 Tesseract(PyMuPDF 렌더)→ocrmypdf 순으로 폴백 시도
  - Windows에서 자동 OCR을 활용하려면:
    1) Tesseract OCR 설치(권장: UB Mannheim 배포본, kor 언어팩 포함)
    2) `pip install pytesseract pillow pymupdf`
    3) 재실행: `python scripts/quickstart.py --pdf data/tests --backend auto --ocr auto`
