# 정수장 챗봇 시스템 기술 보고서

## 1. 시스템 개요

본 시스템은 PDF 문서에서 데이터를 추출하고 LLM을 통해 질문에 대한 답변을 생성하는 RAG(Retrieval-Augmented Generation) 기반 챗봇입니다. 정수장 도메인에 특화된 질문-답변 시스템으로, 정확도 1순위, 속도 2순위, 최적화 3순위를 지향합니다.

## 2. 핵심 기술 스택

### 2.1 LLM (Large Language Model)
- **모델**: Llama 3 8B Instruct (Q4_K_M 양자화)
- **배포**: Ollama 로컬 서버 (http://127.0.0.1:11434)
- **특징**: 한국어 특화 프롬프트 엔지니어링, 도메인별 답변 가이드라인

### 2.2 임베딩 모델
- **모델**: jhgan/ko-sroberta-multitask
- **라이브러리**: Sentence Transformers
- **차원**: 768차원 벡터
- **특징**: 한국어 다중 작업 학습 모델

### 2.3 벡터 저장소
- **FAISS**: Facebook AI Similarity Search (CPU 최적화)
- **HNSW**: Hierarchical Navigable Small World
- **TF-IDF**: 폴백용 인메모리 벡터화
- **자동 선택**: auto 모드에서 FAISS → HNSW → TF-IDF 순서

### 2.4 검색 알고리즘
- **BM25**: 3-5 문자 n-gram 기반 키워드 검색
- **RRF**: Reciprocal Rank Fusion (가중치: 벡터 0.6, BM25 0.4)
- **하이브리드 검색**: 의미적 검색 + 키워드 검색 결합

## 3. 시스템 아키텍처

### 3.1 핵심 파이프라인 (UnifiedPDFPipeline)

```
질문 입력 → 질문 분석 → 하이브리드 검색 → RRF 병합 → 중복 제거 → 
점수 교정/필터링 → 리랭킹 → 컨텍스트 구성 → 가드레일 검사 → 
LLM 생성 → 답변 후처리 → 메트릭 수집
```

### 3.2 주요 모듈 구성

#### 3.2.1 질문 분석기 (analyzer.py)
- **기능**: 질문 유형 분류 및 검색 전략 결정
- **분류 유형**: 
  - numeric: 수치/단위 질문
  - definition: 정의/개념 질문
  - procedural: 절차/방법 질문
  - comparative: 비교 질문
  - system_info: 시스템 정보 질문
  - technical_spec: 기술 사양 질문
  - operational: 운영 관련 질문
  - problem: 문제 해결 질문
- **도메인 사전**: 정수장 전문 용어 기반 분류

#### 3.2.2 검색기 (retriever.py)
- **HybridRetriever**: 벡터 + BM25 하이브리드 검색
- **병렬 처리**: ThreadPoolExecutor를 통한 동시 검색
- **캐싱**: LRU 캐시로 검색 결과 재사용
- **타임아웃**: 검색 시간 제한 (SEARCH_TIMEOUT_S)

#### 3.2.3 리랭커 (reranker.py)
- **CrossEncoder**: BAAI/bge-reranker-v2-m3 모델
- **경량 리랭커**: 문자 n-gram 오버랩 기반 폴백
- **타임아웃 보호**: RERANK_TIMEOUT_S 제한

#### 3.2.4 LLM 인터페이스 (llm.py)
- **Ollama API**: HTTP 기반 로컬 LLM 호출
- **프롬프트 엔지니어링**: 정수장 도메인 특화 가이드라인
- **재시도 메커니즘**: 백오프를 통한 안정성 확보
- **타임아웃**: LLM_TIMEOUT_S 제한

## 4. 데이터 처리 기술

### 4.1 PDF 처리 (pdf_processor.py)
- **추출기**: pdfplumber, PyMuPDF 지원
- **OCR**: Tesseract 기반 이미지 텍스트 추출
- **슬라이딩 윈도우 청킹**: 
  - 기본 크기: 800자, 오버랩: 200자
  - 정수장 특화: 900자, 25% 오버랩 비율
  - 경계 스냅: 문장/공백 경계에 ±5% 윈도우 조정
  - 문단 단위 보존을 위한 스마트 청킹
- **도메인 특화**: 정수장 문서 최적화 청킹

### 4.2 벡터화 (embedding.py)
- **배치 처리**: 32개 텍스트 동시 임베딩
- **정규화**: L2 정규화 적용
- **GPU 지원**: CUDA 가속 (선택적)

### 4.3 컨텍스트 구성 (context.py)
- **동적 k 선택**: 질문 유형별 컨텍스트 수 조정
  - 수치 질문: k=8 (더 많은 컨텍스트 필요)
  - 정의 질문: k=4-6 (질문 길이에 따라 조정)
  - 일반 질문: k=6 (기본값)
- **이웃 청크 추가**: 
  - 문단 단위: 같은 문단 내 최대 1개 이웃 청크
  - 페이지 단위: 인접 페이지(±1)에서 최대 1개 청크
  - 숫자 입력 시 양옆 청크 포함으로 수치 정보 보존
- **중복 제거**: Jaccard 유사도 기반 근사 중복 제거

## 5. 품질 보장 기술

### 5.1 점수 교정 (filtering.py)
- **소스별 정규화**: 벡터/BM25 점수 min-max 정규화
- **z-score 캡핑**: 이상치 제거
- **임계값 조정**: 질문 유형별 동적 임계값

### 5.2 가드레일 (guardrail.py)
- **오버랩 검사**: 질문-컨텍스트 유사도 (≥0.12)
- **핵심 토큰**: 도메인 키워드 매칭 (≥1개)
- **폴백 메커니즘**: 저신뢰도 재검색 → 단일 스팬 → 표준 부정응답

### 5.3 수치 검증 (measurements.py)
- **단위 동의어**: mg/L ↔ ppm, ug/L ↔ ppb 등 정수장 특화 단위 변환
- **허용오차**: ±5% 수치 정확도 검증
- **측정값 추출**: 정규표현식 기반 수치/단위 추출
- **슬라이딩 윈도우 활용**:
  - 청크 오버랩을 통한 수치 정보 연속성 보장
  - 숫자 입력 시 양옆 청크의 수치 데이터 포함
  - 문단 경계에서 수치 정보 손실 방지
  - 측정값 맵핑: 컨텍스트별 수치/단위 매핑 테이블 구축

## 6. 성능 최적화

### 6.1 병렬 처리
- **검색 병렬화**: 벡터/BM25 동시 실행
- **배치 임베딩**: 다중 텍스트 동시 처리
- **비동기 처리**: FastAPI 기반 비동기 API

### 6.2 캐싱 전략
- **검색 캐시**: LRU 기반 검색 결과 캐싱
- **임베딩 캐시**: 벡터 저장소 사전 구축
- **설정 해시**: config_hash 기반 캐시 무효화

### 6.3 메모리 관리
- **인덱스 압축**: FAISS/HNSW 압축 인덱스
- **배치 크기 조정**: 메모리 사용량 최적화
- **가비지 컬렉션**: 명시적 메모리 해제

## 7. 모니터링 및 메트릭

### 7.1 성능 메트릭
- **검색 시간**: 벡터/BM25 검색 소요 시간
- **생성 시간**: LLM 답변 생성 시간
- **총 처리 시간**: end-to-end 파이프라인 시간

### 7.2 품질 메트릭
- **신뢰도**: 컨텍스트 신뢰도 + 가드레일 오버랩
- **정확도**: 정답 대비 답변 정확도 (키워드/수치/단위 가중치)
- **수치 보존**: 컨텍스트-답변 간 수치 일치도

### 7.3 시스템 메트릭
- **캐시 히트율**: 검색 캐시 효율성
- **폴백 사용**: 저신뢰도 재검색 빈도
- **에러율**: LLM/검색 실패율

## 8. 배포 및 운영

### 8.1 로컬 실행
- **CLI**: 수동 질문-답변 인터페이스
- **벤치마크**: 자동화된 성능 평가
- **서버**: FastAPI 기반 REST API

### 8.2 Docker 배포
- **컨테이너화**: app + ollama 서비스
- **볼륨 마운트**: 데이터/모델/인덱스 영속화
- **헬스체크**: 서비스 상태 모니터링

### 8.3 설정 관리
- **환경별 설정**: 개발/운영 환경 분리
- **동적 설정**: 런타임 파라미터 조정
- **설정 해시**: 재현 가능한 실험 관리

## 9. 슬라이딩 윈도우 기반 청킹 전략

### 9.1 기본 슬라이딩 윈도우
- **윈도우 크기**: 800자 (기본), 900자 (정수장 특화)
- **오버랩**: 200자 (기본), 225자 (정수장 특화, 25% 비율)
- **스텝 크기**: 윈도우 크기 - 오버랩 = 600자 (기본), 675자 (정수장)
- **경계 스냅**: 문장/공백 경계에 ±5% 윈도우 조정으로 의미 단위 보존

### 9.2 숫자 입력 시 양옆 청크 포함 전략
- **수치 질문 감지**: 정규표현식 기반 숫자/단위 패턴 인식
- **이웃 청크 확장**: 
  - 문단 단위: 같은 문단 내 최대 1개 이웃 청크 추가
  - 페이지 단위: 인접 페이지(±1)에서 최대 1개 청크 추가
- **수치 정보 보존**: 
  - 청크 경계에서 수치 데이터 손실 방지
  - 측정값 연속성 보장을 위한 오버랩 활용
  - 단위 변환 및 동의어 매핑 지원

### 9.3 정수장 도메인 최적화
- **공정 연속성**: 착수→약품→혼화응집→침전→여과→소독 공정 순서 보존
- **측정값 연속성**: pH, 탁도, 용존산소 등 수질 지표 연속 추적
- **단위 표준화**: mg/L, ppm, NTU, pH 등 정수장 표준 단위 지원
- **문서 구조 보존**: 섹션/문단 단위 의미적 경계 유지

## 10. 도메인 특화 기능

### 10.1 정수장 전문 용어
- **공정 용어**: 착수, 약품, 혼화응집, 침전, 여과, 소독
- **시스템 용어**: AI 플랫폼, 자율운영, 대시보드, SCADA
- **모델 용어**: LSTM, GRU, N-beats, XGB, GBR
- **성능 지표**: R², MAE, MSE, RMSE

### 10.2 질문 유형별 최적화
- **시스템 정보**: BM25 가중치 증가 (정확한 키워드 매칭)
- **운영/절차**: 벡터 가중치 증가 (의미적 유사성)
- **수치 질문**: 낮은 임계값 (0.16) 적용

### 10.3 한국어 특화
- **프롬프트**: 한국어 전용 답변 지시
- **토큰화**: 한국어 문자 n-gram 처리
- **정규화**: 한국어 텍스트 정규화

## 11. 세부 기술 요소

### 11.1 유틸리티 함수 (utils.py)
- **텍스트 정규화**: 공백, 하이픈, 줄바꿈 정규화로 안정적 해싱
- **MD5 해싱**: 텍스트의 첫 160자 MD5 해시로 청크 식별
- **문자 n-gram**: 3-5자 n-gram 생성으로 유사도 계산
- **Jaccard 유사도**: 집합 교집합/합집합 비율로 중복도 측정
- **오버랩 비율**: 질문-컨텍스트 간 n-gram 오버랩 계산
- **Z-score 정규화**: 평균/표준편차 기반 점수 정규화
- **키 토큰 추출**: 한국어/영문 알파벳, 숫자, 기호 추출 (길이≥2)
- **타임아웃 예산**: 남은 처리 시간 계산

### 11.2 가드레일 시스템 (guardrail.py)
- **오버랩 검사**: 질문-컨텍스트 유사도 임계값 (≥0.12)
- **핵심 토큰 검사**: 도메인 키워드 매칭 (≥1개)
- **문장별 유사도**: 개별 문장의 낮은 유사도 카운트
- **하드 블록**: 조건 미충족 시 답변 차단
- **스니펫 경고**: 매우 낮은 유사도 문장 수 추적

### 11.3 타임아웃 관리 (timeouts.py)
- **환경변수 설정**: LLM(60s), 리랭킹(10s), 검색(5s) 타임아웃
- **Windows 안전**: SIGALRM 대신 ThreadPoolExecutor 사용
- **예외 처리**: 타임아웃/예외 시 기본값 반환
- **동시성 제어**: 최대 1개 워커로 안전한 실행

### 11.4 OCR 후교정 (ocr_corrector.py)
- **노이즈 점수**: OCR 오류 패턴 기반 품질 평가
  - 유니코드 대체 문자() 비율
  - 의심스러운 바이그램 (rn, cl, 0O, O0, l1, 1l)
  - 구두점 비율
- **배치 처리**: 4개 텍스트씩 묶어서 LLM 교정
- **도메인 사전**: 정수장 전문 용어 기반 교정
- **품질 임계값**: 0.5 이상 노이즈 점수만 교정 대상
- **문자 예산**: 최대 10,000자까지 교정 처리

### 11.5 도메인 사전 (domain_dictionary.py)
- **정수장 전문 용어**: 8개 카테고리 200+ 용어
  - 응집제/화학약품, 처리시설/공정, 수질지표/측정항목
  - 처리공정/운영, 시설물/장비, 단위/수치
  - 정수장 시스템/플랫폼, AI 모델/알고리즘
- **단위 변환 규칙**: 유량, 농도, 압력, 온도 변환표
- **수치 범위 기준**: pH, 탁도, 잔류염소 등 정상/이상 범위
- **OCR 오류 패턴**: 자주 오인식되는 문자 매핑
- **질문 유형 키워드**: 5가지 질문 유형별 키워드 분류

### 11.6 메트릭 수집 (metrics.py)
- **성능 지표**: P50/P95 총 처리시간, 필터 통과율
- **품질 지표**: 컨텍스트 채움률, 수치 보존률, 오버랩 비율
- **시스템 지표**: 무답변률, 캐시 히트율
- **백분위수 계산**: 선형 보간을 통한 정확한 백분위수
- **출력 형식**: JSON(상세), CSV(표) 지원

### 11.7 데이터 타입 (types.py)
- **Chunk**: 문서 청크 메타데이터
  - 이웃 힌트: ±1 페이지/위치 정보
  - 추가 메타데이터: 섹션, 문단ID, 측정값
- **RetrievedSpan**: 검색된 청크 스팬
  - 소스별 점수: 벡터, BM25, 리랭킹 점수
  - 교정된 신뢰도: 정규화된 신뢰도 점수
- **Answer**: 최종 답변 객체
  - 폴백 사용 여부: 저신뢰도 재검색 등

### 11.8 PDF 처리 기술
- **다중 추출기**: pdfplumber, PyMuPDF, pymupdf4llm
- **자동 선택**: 텍스트 품질 기반 최적 추출기 선택
- **OCR 통합**: Tesseract 기반 이미지 텍스트 추출
- **마크다운 변환**: LLM 최적화된 구조 보존
- **배치 처리**: 여러 PDF 동시 처리

### 11.9 서버 API (server/app.py)
- **FastAPI 기반**: 비동기 REST API
- **엔드포인트**: /api/ask, /api/qa/batch, /healthz, /metrics
- **요청 모델**: Pydantic 기반 타입 검증
- **메트릭 수집**: Prometheus 형식 메트릭
- **워밍업**: 첫 요청 시 파이프라인 초기화

### 11.10 자동화 스크립트 (autorun.py)
- **의존성 검사**: 필수 패키지 설치 확인
- **PyTorch 최적화**: CPU 전용 휠 설치
- **PDF 탐색**: data/pdfs → data/tests → ./pdfs 순서
- **Ollama 확인**: LLM 서버 상태 검사
- **원클릭 실행**: 설치부터 벤치마크까지 자동화

### 11.11 고급 최적화 기법
- **캐시 무효화**: 코퍼스 시그니처 + 설정 해시
- **병렬 검색**: 벡터/BM25 동시 실행
- **배치 임베딩**: 32개 텍스트 동시 처리
- **메모리 관리**: LRU 캐시, 명시적 가비지 컬렉션
- **타임아웃 예산**: 검색 시간 제한 내 최적화

### 11.12 Windows 호환성
- **경로 처리**: UTF-8 인코딩, POSIX 경로 대응
- **프로세스 관리**: ThreadPoolExecutor 기반 안전한 실행
- **로그 관리**: 파일 기반 로깅, 에러 추적
- **환경변수**: 런타임 설정 오버라이드

## 12. 결론

본 시스템은 정수장 도메인에 특화된 고성능 RAG 챗봇으로, 하이브리드 검색, 도메인 특화 분석, 다층 품질 보장 메커니즘을 통해 정확하고 신뢰할 수 있는 답변을 제공합니다. 모듈화된 아키텍처와 포괄적인 모니터링을 통해 유지보수성과 확장성을 확보했습니다.

## 부록 A. 기술성 평가 요약 및 보완 권고

### A.1 기술적 한계 요약
- **RAG 한계**: 문맥 미회수 시 잔여 환각, 임베딩·벡터 검색·재랭킹 추가로 지연·병목, 도메인 특화 용어 검색 부정확 가능.
- **로컬 LLM 운용 리스크**: 초기 GPU/스토리지/전력 비용, 운영 복잡성, 확장성·가용성 저하 위험.
- **보안 이슈**: 데이터 분할·접근제어 필수, 프롬프트 인젝션 대비, 벡터DB 암호화·키 관리 필요.

### A.2 기술 보완 방안
- **검색 정확도**: BM25+벡터 하이브리드 고도화, 지식 그래프 보강 재랭킹, 정기 임베딩 재학습과 품질 점검.
- **모델·배치 전략**: 3B~7B 경량 로컬 모델 우선, 고난도 쿼리는 클라우드 대형 모델 부분 위임(하이브리드).
- **보안·거버넌스**: 벡터DB 암호화, RBAC·접근로그 모니터링, 프롬프트 필터·정책 적용.

### A.3 설계 완성도 및 누락 요소
- **데이터 생명주기**: 출처·품질·편향 점검 루틴, 민감정보 동의/비식별 절차 명시 필요.
- **모델 평가·검증**: 정확도·공정성·환각·설명가능성 지표와 테스트셋, 상시 모니터링 체계 설계 필요.
- **인적 요소**: 사용자 교육, 내부 가이드라인·감사, 윤리위원회 및 승인 워크플로우 보강.
- **기능 확장성**: AML/신용/대출/내부통제 등 모듈화, 다국어·음성·이미지 등 멀티모달 고려.

### A.4 프로젝트 반영 포인트(현 저장소 기준)
- **검색/랭킹**: `src/unifiedpdf/retriever.py`의 RRF/하이브리드 강화, 도메인 사전(`domain_dictionary.py`) 보강.
- **품질/보안**: `guardrail.py` 프롬프트 필터 확장, `metrics.py` 품질 지표 확대, 벡터 저장소 암호화 옵션 검토.
- **운영 자동화**: `scripts/build_vector_index.py` 정기 재임베딩, `scripts/run_qa_benchmark.py` 상시 벤치마크, `server/app.py` 접근로그·RBAC 연계.
- **데이터 파이프라인**: `scripts/build_corpus_from_pdfs.py` 출처·품질 로그와 비식별 파이프라인, `domain_dictionary.py` 용어·단위 테이블 고도화.